name: Python CI

on:
  push:
    branches: [ cd ]
  pull_request:
    branches: [ cd ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repo
      - uses: actions/checkout@v3

      # Cache pip dependencies
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort pytest
          # Install the package in editable mode
          pip install -e .

      # Auto-format code with Black
      - name: Format code with Black
        run: black . --diff

      # Auto-sort imports with isort
      - name: Sort imports with isort
        run: isort . --diff

      # Run flake8 for linting (ignore style handled by Black)
      - name: Run flake8 (linting)
        run: flake8 . --max-line-length=100 --ignore=E203,W503

      # Run tests
      - name: Run tests
        run: pytest -v

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v3

      # Cache Docker layers
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build images using docker-compose
      - name: Build images with docker-compose
        run: docker compose -f docker-compose.yml build

      # Validate docker-compose config
      - name: Compose config validation
        run: docker compose -f docker-compose.yml config
